<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Williamdes&#x27;s blog - Add a crypt data volume to Alpine 3.17</title>

        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <!-- Enable responsiveness on mobile devices-->
        <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

        <!-- Standard meta tags -->
        <meta name="author" content="William Desportes">
        <meta name="description" content="Add a crypt data volume to Alpine 3.17">

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@wdesportes" />
        <meta name="twitter:creator" content="@wdesportes" />

        <!-- Open Graph Tags -->
        <meta property="og:locale" content="en_US" />
        <meta property="og:site_name" content="Williamdes's blog">
        
        <meta property="og:title" content="Add a crypt data volume to Alpine 3.17">
        <meta property="og:url" content="https://blog.williamdes.eu/Infrastructure/tutorials/add-a-crypt-data-volume-to-alpine-3-17">
        <meta property="og:description" content="Add a crypt data volume to Alpine 3.17">
        
        <meta property="og:type" content="article">
        <meta name="publish_date" property="og:publish_date" content="2022-05-20T00:07:00+00:02">
        <meta property="article:published_time" content="2022-05-20T00:07:00">
        <meta property="article:modified_time" content="2025-01-26T00:51:00">
        <meta property="article:author" content="https://williamdes.eu">
        <meta property="article:tags" content="infra-tutorial"><meta property="article:tags" content="LUKS">
        

        <!-- CSS -->
        <link rel="stylesheet" href="https://blog.williamdes.eu/main.css">

        <!-- Feeds -->
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.williamdes.eu/atom.xml">




    
    

    
    

    
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement":
        [
            {
                "@type": "ListItem",
                "position": 1,
                "item": {
                    "@id": "https://blog.williamdes.eu",
                    "name": "Williamdes's blog"
                }
            },
            {
                "@type": "ListItem",
                "position": 2,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure",
                    "name": "Infrastructure"
                }
            },
            {
                "@type": "ListItem",
                "position": 3,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure/tutorials",
                    "name": "tutorials"
                }
            },
            {
                "@type": "ListItem",
                "position": 4,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure/tutorials/add-a-crypt-data-volume-to-alpine-3-17",
                    "name": "Add a crypt data volume to Alpine 3.17"
                }
            }
        ]
    }
</script>
<script type="application/ld+json">
{
    "@context":"http://schema.org",
    "@type": "BlogPosting",
    
    
    "url": "https://blog.williamdes.eu/Infrastructure/tutorials/add-a-crypt-data-volume-to-alpine-3-17/",
    "headline": "Add a crypt data volume to Alpine 3.17",
    "alternativeHeadline": "Add a crypt data volume to Alpine 3.17",
    "dateCreated": "2022-05-20T00:07:00+0002",
    "datePublished": "2022-05-20T00:07:00+0002",
    "dateModified": "2025-01-26T00:51:00+0002",
    "inLanguage": "en",
    "isFamilyFriendly": "true",
    "author": {
        "@type": "Person",
        "name": "William Desportes",
        "url": "https://williamdes.eu"
    },
    "mainEntityOfPage": "True",
    "keywords": ["cryptsetup","crypttab","luks"],
    "articleSection": "Tutorial",
    "genre": ["infra-tutorial","LUKS"]
}
</script>
<!-- Matomo -->
        <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="https://analytics.wdes.eu/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '1']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
        </script>
        <noscript><p><img src="https://analytics.wdes.eu/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Matomo Code -->
    </head>

    <body class="single">

    
        <header class="header">
            <nav class="nav">
                
                <p class="logo"><a href="https://blog.williamdes.eu">Williamdes&#x27;s blog</a></p>
                
                <ul class="menu">
                    
                </ul>
            </nav>
        </header>

        <main class="main">
            
<article class="post-single">
    <header class="post-header">
        <h1 class="post-title">Add a crypt data volume to Alpine 3.17</h1>
        
        <div class="post-meta">
            Author: <a class="post-author" href="https://williamdes.eu">
                William Desportes
            </a>
            
            <br/>
            <span class="post-date">Published: <time datetime="2022-05-20T00:07:00+0002">May 20, 2022 00:07</time></span>
            <span class="post-date"> and updated: <time datetime="2025-01-26T00:51:00+0002">January 26, 2025 00:51</time></span>
            <span>&middot;</span>
            <span class="post-reading-time">2 min read</span>
        </div>
    </header>
    <div class="post-content"><p>Add a crypt data volume to Alpine 3.17</p>
<span id="continue-reading"></span>
<p>This is how to setup a data volume on an already configured Alpine 3.17 system.</p>
<p>The disk is at: <code>/dev/sdb</code>, it also could be <code>/dev/vdb</code></p>
<h3 id="creating-partitions">Creating partitions</h3>
<p>You can even skip this step and use all the disk at once.
Just rename <code>sdb1</code> to <code>sdb</code> in other commands &amp; scripts.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">fdisk</span><span> /dev/sdb
</span></code></pre>
<p>Enter the keyboard sequence:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># p
</span><span style="color:#65737e;"># n
</span><span style="color:#65737e;"># p
</span><span style="color:#65737e;"># 1
</span><span style="color:#65737e;"># ENTER
</span><span style="color:#65737e;"># ENTER
</span><span style="color:#65737e;"># p
</span><span style="color:#65737e;"># w
</span></code></pre>
<h3 id="creating-luks-setup">Creating LUKS setup</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">apk</span><span> add</span><span style="color:#bf616a;"> --update</span><span> cryptsetup lsblk
</span></code></pre>
<h3 id="creating-the-luks-lvm-ext4-partition">Creating the LUKS/LVM/EXT4 partition</h3>
<p>Make the LUKS drive:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cryptsetup</span><span> benchmark</span><span style="color:#bf616a;"> --cipher</span><span>=aes-xts-plain64
</span><span style="color:#65737e;"># Source: https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#Encryption_options_with_dm-crypt
</span><span style="color:#65737e;"># Use --pbkdf=pbkdf2 for Grub to be able to unlock at boot time
</span><span style="color:#bf616a;">cryptsetup</span><span> luksFormat</span><span style="color:#bf616a;"> --cipher</span><span>=aes-xts-plain64</span><span style="color:#bf616a;"> --key-size</span><span>=512</span><span style="color:#bf616a;"> --hash</span><span>=sha512</span><span style="color:#bf616a;"> --pbkdf</span><span>=pbkdf2 /dev/sdx1
</span><span style="color:#bf616a;">cryptsetup</span><span> luksDump /dev/sdx1
</span><span style="color:#bf616a;">cryptsetup</span><span> luksOpen /dev/sdx1 enc_storage
</span></code></pre>
<p>Create LVM and ext4 into it:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">mkfs.ext4</span><span> /dev/mapper/enc_storage
</span></code></pre>
<p>Mount it:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">mkdir</span><span> /mnt/storage
</span><span style="color:#bf616a;">lsblk
</span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">-e </span><span>&quot;</span><span style="color:#a3be8c;">/dev/mapper/enc_storage\t/mnt/storage\text4\tdefaults\t0\t0\n</span><span>&quot; &gt;&gt; /etc/fstab
</span><span style="color:#bf616a;">mount -a
</span><span style="color:#bf616a;">lsblk
</span><span style="color:#bf616a;">df -h
</span></code></pre>
<h4 id="helper-script">Helper script</h4>
<p>I often put this in <code>~/open.sh</code> to help unlocking the system when I have forgot the commands.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;">#!/bin/sh -exu
</span><span>
</span><span style="color:#bf616a;">cryptsetup</span><span> luksOpen /dev/sdb1 enc_storage
</span><span style="color:#bf616a;">mount -a -v
</span><span style="color:#65737e;">#echo &#39;Starting docker&#39;
</span><span style="color:#65737e;">#rc-service docker start
</span><span style="color:#65737e;">#echo &#39;Waiting 4sec for Docker to start&#39;
</span><span style="color:#65737e;">#sleep 4
</span><span style="color:#96b5b4;">echo </span><span>&#39;</span><span style="color:#a3be8c;">Done !</span><span>&#39;
</span></code></pre>
<h4 id="or-crypttab">Or <code>crypttab</code></h4>
<p>See: https://manpages.ubuntu.com/manpages/focal/en/man5/crypttab.5.html - <code>initramfs</code> "This option is specific to the Debian crypttab format. It's not supported by systemd." - <code>luks</code> "Force LUKS mode" - <code>discard</code> "Allow using of discards (TRIM) requests for device"</p>
<p>Use <code>lsblk -o uuid,mountpoint,path | grep -F "/dev/sdb1"</code>
Add <code>enc_storage UUID=xxx-xxx-xx-xx-xxxx none luks,discard,initramfs</code> to <code>/etc/crypttab</code>
And <code>update-initramfs -c -k $(uname -r)</code></p>
<p>See: https://serverfault.com/a/1101450/336084</p>
</div>
    <footer class="post-footer">
        
        <ul class="post-tags">
        
            <li><a href="https://blog.williamdes.eu/tags/infra-tutorial/">infra-tutorial</a></li>
        
            <li><a href="https://blog.williamdes.eu/tags/luks/">LUKS</a></li>
        
        </ul>
        
    </footer>
</article>

        </main>

        <footer class="footer">
            <span>&copy; 2021-2025 <a href="https://blog.williamdes.eu">Williamdes&#x27;s blog</a></span>
            <span>&middot;</span>
            <span>Powered by <a href="https://www.getzola.org" rel="noopener" target="_blank">Zola</a></span>
            <span>&middot;</span>
            <span>Theme <a href="https://github.com/schoenenberg/zola-paper" rel="noopener" target="_blank">Zola-Paper</a></span>
            <br>
            <span><a href="https://github.com/wdesportes/blog.williamdes.eu" rel="noopener" target="_blank">Source code on GitHub</a></span>
            <span>&middot;</span>
            <span><a href="https://github.com/wdesportes/blog.williamdes.eu/discussions" rel="noopener" target="_blank">Found a bug ?</a></span>
            <span>&middot;</span>
            <span><a href="https://williamdes.eu" rel="noopener" target="_blank">Visit my personal website</a></span>
            <span>&middot;</span>
            <span><a href="https://blog.williamdes.eu/atom.xml" rel="noopener" target="_blank" type="application/rss+xml">RSS feed</a></span>
            <br>
            <span>If you are searching for cookies, this is not a bakery website ^^</span>
        </footer>
    
    </body>
</html>
