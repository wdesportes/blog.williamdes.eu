<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Williamdes&#x27;s blog - Monitoring an UPS using Zabbix and Apcupsd</title>

        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <!-- Enable responsiveness on mobile devices-->
        <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

        <!-- Standard meta tags -->
        <meta name="author" content="William Desportes">
        <meta name="description" content="Monitoring my Eaton Ellipse PRO 650 on Zabbix with Zabbix agent and Apcupsd.">

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@wdesportes" />
        <meta name="twitter:creator" content="@wdesportes" />

        <!-- Open Graph Tags -->
        <meta property="og:locale" content="en_US" />
        <meta property="og:site_name" content="Williamdes's blog">
        
        <meta property="og:title" content="Monitoring an UPS using Zabbix and Apcupsd">
        <meta property="og:url" content="https://blog.williamdes.eu/Infrastructure/tutorials/monitor-ups-with-zabbix-agent-using-apcupsd">
        <meta property="og:description" content="Monitoring my Eaton Ellipse PRO 650 on Zabbix with Zabbix agent and Apcupsd.">
        
        
        <meta property="og:image" content="https://blog.williamdes.eu/processed_images/Zabbix-UPS-Apcupsd-latest-data.c158f9b67645ca8f.jpg"/>
        <meta property="og:image:width" content="1200"/>
        <meta property="og:image:height" content="627"/>
        
        <meta property="og:type" content="article">
        <meta name="publish_date" property="og:publish_date" content="2024-05-07T16:59:00+00:02">
        <meta property="article:published_time" content="2024-05-07T16:59:00">
        <meta property="article:modified_time" content="2024-05-07T16:59:00">
        <meta property="article:author" content="https://williamdes.eu">
        <meta property="article:tags" content="infra-tutorial"><meta property="article:tags" content="Zabbix">
        

        <!-- CSS -->
        <link rel="stylesheet" href="https://blog.williamdes.eu/main.css">

        <!-- Feeds -->
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.williamdes.eu/atom.xml">




    
    

    
    

    
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement":
        [
            {
                "@type": "ListItem",
                "position": 1,
                "item": {
                    "@id": "https://blog.williamdes.eu",
                    "name": "Williamdes's blog"
                }
            },
            {
                "@type": "ListItem",
                "position": 2,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure",
                    "name": "Infrastructure"
                }
            },
            {
                "@type": "ListItem",
                "position": 3,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure/tutorials",
                    "name": "tutorials"
                }
            },
            {
                "@type": "ListItem",
                "position": 4,
                "item": {
                    "@id": "https://blog.williamdes.eu/Infrastructure/tutorials/monitor-ups-with-zabbix-agent-using-apcupsd",
                    "name": "Monitoring an UPS using Zabbix and Apcupsd"
                }
            }
        ]
    }
</script>
<script type="application/ld+json">
{
    "@context":"http://schema.org",
    "@type": "BlogPosting",
    
    
    "url": "https://blog.williamdes.eu/Infrastructure/tutorials/monitor-ups-with-zabbix-agent-using-apcupsd/",
    "headline": "Monitoring an UPS using Zabbix and Apcupsd",
    "alternativeHeadline": "Monitoring an UPS using Zabbix and Apcupsd",
    "dateCreated": "2024-05-07T16:59:00+0002",
    "datePublished": "2024-05-07T16:59:00+0002",
    "dateModified": "2024-05-07T16:59:00+0002",
    "inLanguage": "en",
    "isFamilyFriendly": "true",
    "author": {
        "@type": "Person",
        "name": "William Desportes",
        "url": "https://williamdes.eu"
    },
    "mainEntityOfPage": "True",
    "keywords": ["infra-tutorial","Zabbix"],
    "articleSection": "Tutorial",
    "genre": ["infra-tutorial","Zabbix"]
}
</script>
<script>
            function setTheme() {
                const time = new Date();

                const prev = localStorage.getItem('date');
                const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

                const now = time.getTime();
                let sunrise;
                let sunset;

                function setBodyClass() {
                    if (now > sunrise && now < sunset) return;
                    document.body.classList.add('dark');
                }

                if (date !== prev) {
                    fetch('https://api.ipgeolocation.io/astronomy?apiKey=f96ef8fc7d8247deae9022b4cedd6f97')
                        .then(res => res.json())
                        .then(data => {
                            sunrise = data.sunrise.split(':').map(Number);
                            sunset = data.sunset.split(':').map(Number);
                    })
                    .catch(() => {
                        sunrise = [7, 0];
                        sunset = [19, 0];
                    })
                    .finally(() => {
                        sunrise = time.setHours(sunrise[0], sunrise[1], 0);
                        sunset = time.setHours(sunset[0], sunset[1], 0);
                        setBodyClass();
                        localStorage.setItem('sunrise', sunrise);
                        localStorage.setItem('sunset', sunset);
                    });
                    localStorage.setItem('date', date);
                } else {
                    sunrise = Number(localStorage.getItem('sunrise'));
                    sunset = Number(localStorage.getItem('sunset'));
                    setBodyClass();
                }
            }
        </script>
        <!-- Matomo -->
        <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="//analytics.wdes.eu/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '1']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
        </script>
        <noscript><p><img src="//analytics.wdes.eu/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Matomo Code -->
    </head>

    <body class="single">

    <!-- Apply theme -->
    <script>
      setTheme();
    </script>

    
        <header class="header">
            <nav class="nav">
                
                <p class="logo"><a href="https://blog.williamdes.eu">Williamdes&#x27;s blog</a></p>
                
                <ul class="menu">
                    
                </ul>
            </nav>
        </header>

        <main class="main">
            
<article class="post-single">
    <header class="post-header">
        <h1 class="post-title">Monitoring an UPS using Zabbix and Apcupsd</h1>
        
        <div class="post-meta">
            Author: <a class="post-author" href="https://williamdes.eu">
                William Desportes
            </a>
            
            <br/>
            <span class="post-date">Published: <time datetime="2024-05-07T16:59:00+0002">May  7, 2024 16:59</time></span>
            <span class="post-date"> and updated: <time datetime="2024-05-07T16:59:00+0002">May  7, 2024 16:59</time></span>
            <span>&middot;</span>
            <span class="post-reading-time">3 min read</span>
        </div>
    </header>
    <div class="post-content"><p>Monitoring my Eaton Ellipse PRO 650 on Zabbix with Zabbix agent and Apcupsd.</p>
<span id="continue-reading"></span>
<p>This is how to monitor an Eaton Ellipse PRO 650 with Zabbix using Zabbix agent and Apcupsd.</p>
<h2 id="required">Required</h2>
<ul>
<li>Have <code>zabbix-agent2</code> installed on your node and you will need a Zabbix server somewhere.</li>
<li>And also install <code>jq</code>.</li>
<li>And of course you will need a configured <code>apcupsd</code>, Ubuntu has a good tutorial for that.</li>
</ul>
<h3 id="check-everyting-is-setup">Check everyting is setup</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> apcupsd</span><span style="color:#bf616a;"> --version
</span><span style="color:#bf616a;">apcupsd</span><span> 3.14.14 (31 May 2016) </span><span style="color:#bf616a;">debian
</span><span style="color:#bf616a;">$</span><span> jq</span><span style="color:#bf616a;"> --version
</span><span style="color:#bf616a;">jq-1.6
</span><span style="color:#bf616a;">$</span><span> zabbix_agent2</span><span style="color:#bf616a;"> --version
</span><span style="color:#bf616a;">zabbix_agent2</span><span> (Zabbix) </span><span style="color:#bf616a;">6.4.13
</span></code></pre>
<h3 id="config-files">Config files</h3>
<p>Create <code>/etc/zabbix/zabbix_agent2.d/userparameter_apcupsd.conf</code></p>
<p>With:</p>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>UserParameter=apcupsd,apcaccess | jq -s -R -f /etc/zabbix/zabbix_agent</span><span style="color:#d08770;">2</span><span>.d/apcupsd_filter.jq
</span></code></pre>
<p>Create <code>/etc/zabbix/zabbix_agent2.d/apcupsd_filter.jq</code></p>
<pre data-lang="jq" style="background-color:#2b303b;color:#c0c5ce;" class="language-jq "><code class="language-jq" data-lang="jq"><span># See https://linux.die.net/man/8/apcaccess
</span><span># Newer versions of jq will have `trim` and some of this mess can be cleaned up
</span><span># See: https://github.com/jqlang/jq/issues/3078#issuecomment-2018999435
</span><span>[
</span><span>
</span><span>    split(&quot;\n&quot;)[] # transform input into array
</span><span>    | split(&quot;: &quot;) # where first element has key names
</span><span>    | select(length==2) # check we have a key and a value
</span><span>    | (
</span><span>       # If the value contains some string or if the key is NUMXFERS
</span><span>       if (.[1] | test(&quot;Seconds|Volts|Percent|Minutes|Hz&quot;; &quot;x&quot;)) or (.[0] | test(&quot;NUMXFERS&quot;; &quot;x&quot;))
</span><span>                      then
</span><span>                        {(.[0]|split(&quot; &quot;)[0]):.[1]|split(&quot; &quot;)[0]|tonumber}
</span><span>                      else
</span><span>                        {(.[0]|split(&quot; &quot;)[0]): .[1]|rtrimstr(&quot; &quot;)|rtrimstr(&quot; &quot;)}
</span><span>                      end
</span><span>       )
</span><span>]
</span><span>| add
</span></code></pre>
<h3 id="check-that-it-works">Check that it works</h3>
<p>Run:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">apcaccess </span><span>| </span><span style="color:#bf616a;">jq -s -R -f</span><span> /etc/zabbix/zabbix_agent2.d/apcupsd_filter.jq
</span></code></pre>
<p>It outputs:</p>
<p>See: <a rel="noopener" target="_blank" href="https://linux.die.net/man/8/apcaccess">man apcaccess</a> for the keys descriptions.</p>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>{
</span><span>  &quot;</span><span style="color:#a3be8c;">APC</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">001,029,0691</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">DATE</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">2024-04-07 16:38:34 +0200</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">HOSTNAME</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">my-machine</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">VERSION</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">3.14.14 (31 May 2016) debian</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">UPSNAME</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">ET_MYUPS</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">CABLE</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">USB Cable</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">DRIVER</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">USB UPS Driver</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">UPSMODE</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Stand Alone</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">STARTTIME</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">2024-04-07 14:01:53 +0200</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">MODEL</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Ellipse PRO</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">STATUS</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">ONLINE</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">LOADPCT</span><span>&quot;: </span><span style="color:#d08770;">10</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">BCHARGE</span><span>&quot;: </span><span style="color:#d08770;">72</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">TIMELEFT</span><span>&quot;: </span><span style="color:#d08770;">34.1</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">MBATTCHG</span><span>&quot;: </span><span style="color:#d08770;">45</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">MINTIMEL</span><span>&quot;: </span><span style="color:#d08770;">30</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">MAXTIME</span><span>&quot;: </span><span style="color:#d08770;">0</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">OUTPUTV</span><span>&quot;: </span><span style="color:#d08770;">233</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">DWAKE</span><span>&quot;: </span><span style="color:#d08770;">-1</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">LOTRANS</span><span>&quot;: </span><span style="color:#d08770;">165</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">HITRANS</span><span>&quot;: </span><span style="color:#d08770;">285</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">ALARMDEL</span><span>&quot;: </span><span style="color:#d08770;">30</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">LINEFREQ</span><span>&quot;: </span><span style="color:#d08770;">50</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">NUMXFERS</span><span>&quot;: </span><span style="color:#d08770;">0</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">TONBATT</span><span>&quot;: </span><span style="color:#d08770;">0</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">CUMONBATT</span><span>&quot;: </span><span style="color:#d08770;">0</span><span>,
</span><span>  &quot;</span><span style="color:#a3be8c;">XOFFBATT</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">N/A</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">STATFLAG</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0x05000008</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">SERIALNO</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">PXXXHXXABD</span><span>&quot;,
</span><span>  &quot;</span><span style="color:#a3be8c;">END</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">2024-04-07 16:39:25 +0200</span><span>&quot;
</span><span>}
</span></code></pre>
<h3 id="zabbix-setup">Zabbix setup</h3>
<p>Download the template: <a href="../Zabbix-UPS-Apcupsd.yaml">Zabbix-UPS-Apcupsd.yaml</a></p>
<p>Import the template in "Data Collection" &gt; "Templates".</p>
<p>Then go to your "Host" and link the template in the "Templates" section.</p>
<h4 id="latest-data">Latest data</h4>
<p>Note: some items do not exist on my UPS, they may exist on yours.
Feel free to add some missing <a rel="noopener" target="_blank" href="https://linux.die.net/man/8/apcaccess">keys</a> and contact me to update the template.</p>
<p><img src="../Zabbix-UPS-Apcupsd-latest-data.jpg" alt="Latest data in Zabbix" title="Latest data in Zabbix" /></p>
<h3 id="some-notes">Some notes</h3>
<p>I was originally using <a rel="noopener" target="_blank" href="https://github.com/cavazquez/zabbix_template_apcupsd">cavazquez's Zabbix template</a>.</p>
</div>
    <footer class="post-footer">
        
        <ul class="post-tags">
        
            <li><a href="https://blog.williamdes.eu/tags/infra-tutorial/">infra-tutorial</a></li>
        
            <li><a href="https://blog.williamdes.eu/tags/zabbix/">Zabbix</a></li>
        
        </ul>
        
    </footer>
</article>

        </main>

        <footer class="footer">
            <span>&copy; 2021-2024 <a href="https://blog.williamdes.eu">Williamdes&#x27;s blog</a></span>
            <span>&middot;</span>
            <span>Powered by <a href="https://www.getzola.org" rel="noopener" target="_blank">Zola</a></span>
            <span>&middot;</span>
            <span>Theme <a href="https://github.com/schoenenberg/zola-paper" rel="noopener" target="_blank">Zola-Paper</a></span>
            <br>
            <span><a href="https://github.com/wdesportes/blog.williamdes.eu" rel="noopener" target="_blank">Source code on GitHub</a></span>
            <span>&middot;</span>
            <span><a href="https://github.com/wdesportes/blog.williamdes.eu/discussions" rel="noopener" target="_blank">Found a bug ?</a></span>
            <span>&middot;</span>
            <span><a href="https://williamdes.eu" rel="noopener" target="_blank">Visit my personal website</a></span>
            <span>&middot;</span>
            <span><a href="https://blog.williamdes.eu/atom.xml" rel="noopener" target="_blank" type="application/rss+xml">RSS feed</a></span>
            <br>
            <span>If you are searching for cookies, this is not a bakery website ^^</span>
        </footer>
    
    </body>
</html>
